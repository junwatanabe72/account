# コード整理計画

## 現状分析

### 🔴 主な問題点

#### 1. 重複した仕訳フォームコンポーネント
現在、9個のJournal関連コンポーネントが存在し、機能が重複している：
- `/src/ui/transactions/FreeeStyleJournalForm.tsx`
- `/src/ui/transactions/FreeeStyleJournalFormWithStore.tsx`
- `/src/ui/transactions/ImprovedJournalForm.tsx`
- `/src/ui/transactions/JournalForm.tsx`
- `/src/ui/transactions/JournalEditModal.tsx`
- `/src/ui/transactions/JournalFilterBar.tsx`
- `/src/ui/transactions/JournalConfirmation.tsx`
- `/src/ui/transactions/LLMJournalProcessor.tsx`
- `/src/ui/journals/JournalManagementPanel.tsx`

#### 2. データ管理の分散
- **AccountingEngine**: 独立したインスタンスとして動作
- **Zustandストア**: 別のデータ管理システム
- 両者間でデータが同期されていない

#### 3. division情報の欠落
- 管理会計(KANRI)と修繕会計(SHUZEN)の区分情報が適切に伝達されない
- 仕訳作成時にdivisionフィールドが渡されていない
- 収支報告書でデータが正しく表示されない

## 📋 整理プラン

### フェーズ1: 不要コードの削除
- 重複する仕訳フォームコンポーネントを統合
- 使用されていないコンポーネントを削除
- 古いバージョンのコードを整理

### フェーズ2: データフローの統一
- Zustandストアを中心にデータを管理
- AccountingEngineはストア内で単一インスタンスとして管理
- データの流れを一方向に統一

### フェーズ3: 必要な機能の再実装
- シンプルな仕訳入力フォーム（1つのみ）
- divisionフィールドの適切な伝達
- トースト通知の確実な表示

## 実装方針の選択肢

### 1. クリーンスタート案
**メリット**
- コードがシンプルになる
- 技術的負債を一掃できる
- 新しいアーキテクチャで始められる

**デメリット**
- 一時的に機能が使えなくなる
- 動作している部分も再実装が必要

**推奨度**: ⭐⭐⭐⭐⭐

### 2. 段階的改善案
**メリット**
- アプリケーションが常に動作する
- リスクが少ない
- 徐々に改善できる

**デメリット**
- 時間がかかる
- 一時的に複雑さが増す可能性
- 古いコードとの共存期間が発生

**推奨度**: ⭐⭐⭐

### 3. アーキテクチャ再設計案
**メリット**
- 根本的な問題を解決
- 将来の拡張性を確保
- ベストプラクティスに従える

**デメリット**
- 設計に時間がかかる
- 大規模な変更が必要
- 学習コストが高い

**推奨度**: ⭐⭐⭐⭐

## 推奨アプローチ

**クリーンスタート案**を推奨します。理由：
1. 現在のコードは複雑になりすぎている
2. 重複が多く、どれが正しい実装か判断が困難
3. データフローを根本から修正する必要がある

## 実装ステップ

### ステップ1: バックアップ
```bash
git stash  # 現在の変更を保存（実施済み）
git branch backup-before-cleanup  # バックアップブランチ作成
```

### ステップ2: 不要ファイルの削除
以下のファイルを削除候補とする：
- 重複した仕訳フォーム（1つを残して削除）
- 使用されていないコンポーネント
- 古いバージョンのファイル

### ステップ3: データアーキテクチャの統一
```
UI Components
    ↓
Zustand Store (Single Source of Truth)
    ↓
AccountingEngine (Store内の単一インスタンス)
    ↓
Data Services (Journal, Report, etc.)
```

### ステップ4: 最小限の機能実装
1. シンプルな仕訳入力フォーム
2. division選択機能
3. トースト通知
4. 収支報告書への反映

### ステップ5: テストと検証
- 仕訳登録が正しく動作するか
- divisionが正しく保存されるか
- 収支報告書にデータが表示されるか

## タイムライン

- **フェーズ1**: 30分（不要コード削除）
- **フェーズ2**: 1時間（データフロー統一）
- **フェーズ3**: 1時間（機能再実装）
- **テスト**: 30分

合計: 約3時間

## 次のアクション

1. このドキュメントを確認
2. 実装方針を決定
3. 作業開始

## 注意事項

- 作業前に必ずバックアップを取る
- 小さな変更を積み重ねる
- 各ステップで動作確認を行う
- コミットは細かく行う