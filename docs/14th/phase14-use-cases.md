# Phase 14: 銀行入金処理と未収金管理のユースケース

## 概要
銀行明細CSVを活用した入金処理の自動化と未収金管理のPOC実装。請求処理は現時点ではシステム外で行い、入金処理と消し込みに焦点を当てる。

## 主要ユースケース

### UC-01: 銀行明細CSVのインポートと仕訳自動作成

#### シナリオ
経理担当者が月次で銀行から取得した入出金明細CSVをシステムにインポートする。

#### 処理フロー
1. CSVファイルをアップロード
2. システムがCSVを解析
3. 入金明細から自動的に仕訳を生成
4. 摘要欄から住戸番号や入金者を識別

#### CSVフォーマット例
```csv
日付,摘要,入金額,出金額,残高
2024-04-25,管理費 101号室 田中様,25000,,5025000
2024-04-25,管理費・修繕費 202号室,45000,,5070000
2024-04-26,カンリヒ 303 ヤマダ,20000,,5090000
```

#### 自動生成される仕訳
```
2024-04-25 普通預金 25,000 / 管理費収入 25,000 (101号室 田中様)
2024-04-25 普通預金 45,000 / 管理費収入 25,000 (202号室)
                        / 修繕積立金収入 20,000
```

---

### UC-02: 標準額との差額がある場合の未収金計上

#### シナリオ
住戸の標準請求額（管理費15,000円、修繕積立金10,000円）に対して、入金額が不足している。

#### 処理パターン

##### パターンA: 一部入金（20,000円入金、5,000円不足）
```
普通預金 20,000 / 管理費収入 15,000
               / 修繕積立金収入 5,000
管理費未収金 5,000 / 修繕積立金収入 5,000
```

##### パターンB: 完全未入金
```
管理費未収金 15,000 / 管理費収入 15,000
修繕積立金未収金 10,000 / 修繕積立金収入 10,000
```

#### 設定データ
```typescript
// 住戸別標準請求額マスタ
const unitStandardAmounts = {
  '101': { managementFee: 15000, repairReserve: 10000 },
  '202': { managementFee: 20000, repairReserve: 15000 },
  '303': { managementFee: 15000, repairReserve: 10000 }
}
```

---

### UC-03: 過入金の処理（前受金計上）

#### シナリオ
標準請求額を超える金額が入金された場合（2ヶ月分まとめて等）。

#### 処理例
標準額25,000円に対して50,000円入金：
```
普通預金 50,000 / 管理費収入 15,000
                / 修繕積立金収入 10,000
                / 管理費前受金 15,000
                / 修繕積立金前受金 10,000
```

---

### UC-04: 未収金の消し込み処理

#### シナリオA: 手動消し込み
前月の未収金に対して、今月入金があった場合。

1. 未収金一覧画面で対象を選択
2. 入金記録と紐付け
3. 消し込み仕訳を作成

```
普通預金 5,000 / 管理費未収金 5,000
```

#### シナリオB: 自動消し込み
次回のCSVインポート時に、同一住戸から入金があれば自動的に未収金を消し込む。

##### 消し込み優先順位
1. 古い未収金から消し込み
2. 管理費 → 修繕積立金の順
3. 延滞金は最後

---

### UC-05: 入金者不明の処理

#### シナリオ
摘要欄から住戸が特定できない入金。

#### 処理
```
普通預金 30,000 / 仮受金 30,000 (入金者不明 - 要確認)
```

後日判明したら振替仕訳：
```
仮受金 30,000 / 管理費収入 20,000 (305号室)
              / 修繕積立金収入 10,000
```

---

### UC-06: 複数月分まとめて入金

#### シナリオ
3ヶ月分（75,000円）がまとめて入金。

#### 処理オプション

##### オプション1: 月別に分割計上
```
普通預金 75,000 / 管理費収入 45,000 (4-6月分)
                / 修繕積立金収入 30,000 (4-6月分)
```

##### オプション2: 詳細仕訳
```
普通預金 75,000 / 管理費収入(4月) 15,000
                / 修繕積立金収入(4月) 10,000
                / 管理費収入(5月) 15,000
                / 修繕積立金収入(5月) 10,000
                / 管理費収入(6月) 15,000
                / 修繕積立金収入(6月) 10,000
```

---

### UC-07: 返金処理

#### シナリオ
退去に伴う過払い分の返金や、誤入金の返金。

#### 処理
```
管理費前受金 15,000 / 普通預金 15,000 (101号室 返金)
修繕積立金前受金 10,000 / 普通預金 10,000
```

---

## システム機能要件

### 1. CSVインポート機能
- 複数銀行フォーマット対応
- インポート履歴管理
- 重複チェック機能

### 2. 入金照合エンジン
- 摘要欄のパターンマッチング
- 金額による自動判定
- 住戸マスタとの照合

### 3. 未収金管理
- 住戸別未収金残高
- 滞納期間管理
- 消し込み履歴

### 4. 仕訳生成ルール
- カスタマイズ可能なルール設定
- 優先順位設定
- 例外処理ルール

### 5. レポート機能
- 未収金一覧表
- 消し込み実績表
- 入金予実対比表

---

## データモデル

### 銀行取引データ
```typescript
interface BankTransaction {
  id: string
  date: string
  description: string // 摘要
  depositAmount?: number
  withdrawalAmount?: number
  balance: number
  status: 'unprocessed' | 'processed' | 'matched' | 'error'
  matchedJournalId?: string
}
```

### 入金照合データ
```typescript
interface PaymentMatching {
  bankTransactionId: string
  unitNumber?: string
  identifiedPayer?: string
  standardAmount: {
    managementFee: number
    repairReserve: number
  }
  actualAmount: number
  difference: number
  matchingStatus: 'auto_matched' | 'manual_matched' | 'unmatched'
  generatedJournals: string[]
}
```

### 未収金管理データ
```typescript
interface Receivable {
  id: string
  unitNumber: string
  accountCode: string // 1301: 管理費未収金, 1302: 修繕積立金未収金
  amount: number
  dueDate: string
  status: 'outstanding' | 'partially_paid' | 'paid'
  createdDate: string
  clearedDate?: string
  clearedByJournalId?: string
}
```

---

## POC実装の優先順位

### フェーズ1（必須機能）
1. CSVインポート基本機能
2. 標準的な入金仕訳の自動生成
3. 未収金の手動消し込み

### フェーズ2（自動化機能）
1. 摘要欄の自動解析
2. 未収金の自動計上
3. 自動消し込み

### フェーズ3（高度な機能）
1. 複数月まとめ入金対応
2. 前受金管理
3. 入金者不明の処理

---

## 成功基準

1. **効率性**: 手動入力時間を80%削減
2. **正確性**: 仕訳ミスを90%削減
3. **可視性**: 未収金状況をリアルタイムで把握
4. **追跡性**: すべての入金処理の履歴を保持

---

## 技術的考慮事項

### CSVパーサー
- 文字コード対応（Shift-JIS、UTF-8）
- 異常データのハンドリング
- 大量データの処理

### 照合アルゴリズム
- ファジーマッチング（表記ゆれ対応）
- 機械学習による精度向上（将来）
- ルールベースとAIのハイブリッド

### データ整合性
- トランザクション処理
- 二重計上防止
- ロールバック機能

このPOC実装により、マンション管理組合の入金処理業務が大幅に効率化され、未収金管理の精度が向上します。